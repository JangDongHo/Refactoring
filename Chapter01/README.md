# Chapter 01. 리팩터링: 첫 번째 예시

## 1. 개요

- 리팩터링이란?
  - 겉으로 드러나는 코드의 기능을 바꾸지 않고 내부 구조를 개선하는 방법
  - 리팩터링을 하면 소프트웨어를 이해하고 수정하기 쉬워짐
  - 리팩터링의 핵심은 처음부터 코드를 완벽하게 짜는 것이 아니라, 개발을 진행하면서 지속적으로 코드를 개선하는 것

> 프로그램이 새로운 기능을 추가하기에 편한 구조가 아니라면, 먼저 기능을 추가하기 쉬운 형태로 리팩터링하고 나서 새로운 기능을 추가하는 것이 좋다.

## 2. 리팩터링의 첫 단계

- 리팩터링할 코드 영역을 꼼꼼하게 검사해줄 테스트 코드들부터 마련해야 한다.
- 테스트 코드가 없다면, 리팩터링을 시작하기 전에 테스트 코드를 작성해야 한다.
  - 리팩터링에서 테스트의 역할은 매우 중요하다.

> 리팩터링하기 전에 제대로 된 테스트부터 마련한다. 테스트는 반드시 자가진단하도록 만든다.

- 테스트를 작성하는 데 시간이 좀 걸리지만, 신경 써서 만들어두면 디버깅 시간이 줄어서 전체 작업 시간은 오히려 줄어든다.

### 2.1. 함수 쪼개기

> 실습1: [리팩토링 전 코드](./실습/statement_1.js)
> 실습2: [리팩토링 후 코드](./실습/statement_2.js)

- 긴 함수를 리팩터링할 때는 먼저 전체 동작을 각각의 부분으로 나눌 수 있는 지점을 찾는다.
- 그리고 별도 함수를 빼냈을 때 유효범위를 벗어나는 변수, 즉 새 함수에서 곧바로 사용할 수 없는 변수가 있는지 확인한다.
- 값이 바뀌지 않는 변수는 매개변수로 전달하고, 바뀌는 변수는 반환값으로 받는 방식으로 해결한다.

> 리팩터링은 프로그램 수정을 작은 단계로 나눠서 진행한다. 그래서 중간에 실수하더라도 버그를 쉽게 찾을 수 있다.

- 하나의 리팩토링을 문제없이 끝날 때마다 커밋하고, 자잘한 변경들이 어느 정도 의미가 있는 단위로 뭉쳐지면 공유 저장소로 푸시한다.

> 화자가 말하는 꿀팁
>
> 1. 변수의 역할을 쉽게 알 수 있도록 함수의 반환 값에는 항상 result를 사용한다.
> 2. 자바스크립트와 같은 동적 타입 언어를 사용할 때는 타입이 드러나게 작성하면 도움된다.
> 3. 임시 변수들 때문에 로컬 범위에 존재하는 이름이 늘어나서 가독성이 떨어진다면, '임시 변수를 질의 함수로 바꾸기' 기법을 사용한다.

- 지역 변수를 제거해서 얻는 가장 큰 장점은 유효범위를 신경 써야 할 대상이 줄어들기 때문에, 추출 작업이 훨씬 쉬워진다는 것이다.
- 실제로 화자는 추출 작업 전에는 거의 항상 지역 변수부터 제거한다.

- 반복문을 쪼개면 성능이 느려지지 않나?

  - 최신 컴파일러는 이런 최적화를 자동으로 수행한다.
  - 리팩터링이 성능에 상당한 영향을 주기도 하지만, 화자는 개의치 않고 리팩터링을 진행한다.
  - 리팩터링 과정에서 성능이 크게 떨어졌다면 리팩터링 후 시간을 내어 성능을 개선한다.

> 함수 쪼개기 단계를 정리 하자면 다음과 같다.
>
> 1. 반복문 쪼개기 - 변수 값을 누적시키는 부분을 분리
> 2. 문장 슬라이드하기 - 변수 초기화 문장을 변수 값 누적 코드 바로 앞으로 옮김
> 3. 함수 추출하기 - 해당 부분을 별도 함수로 추출
> 4. 변수 인라인하기 - 변수 제거

### 2.2. 계산 단계와 포맷팅 단계 분리하기

> 실습3: [리팩토링 전 코드](./실습/statement_3.js)

- 이전 단계에서는 프로그램의 논리적인 요소를 파악하기 쉽도록 코드의 구조를 보강하는 데 주안점을 두고 리팩터링을 진행했다.
- 이번 단계에서는 개선된 구조 위에 새로운 기능을 추가하는 방법을 살펴본다.
  - 요구 사항: 고객에게 청구서를 보내기 위해 청구서 데이터를 HTML로 변환하는 기능을 추가해야 한다.
- 계산 코드가 모두 분리되어 있기 때문에 일곱 줄짜리 최상단 코드에 대응하는 HTML 버전만 작성하면 된다.
- 하지만, 분리된 계산 함수들이 텍스트 버전인 statement() 안에 중첩 함수로 들어가 있기 때문에 이를 분리해야 한다.
- 텍스트 버전과 HTML 버전 모두 동일한 계산 로직을 사용하도록 하기 위해 계산 단계와 포맷팅 단계를 분리한다.

- 다양한 해결책 중 화자가 가장 선호하는 방식은 **단계 쪼개기**이다. (statement의 로직을 두 단계로 나누는 것)

  1. 첫 단계에서는 statement()에 필요한 데이터를 계산
  2. 다음 단계에서는 앞서 처리한 결과를 텍스트나 HTML로 포맷팅

- 화자는 새로 만든 레코드에 데이터를 채울 때, 복사를 한다.

  - 가변 데이터는 금방 상하기 때문에, 데이터를 최대한 불변처럼 취급해서 다룬다.

- 코드를 모듈화하면 각 부분이 하는 일과 그 부분들이 맞물려 돌아가는 과정을 파악하기 쉬워진다.
- 간결함이 지혜의 정수일지 몰라도, 프로그래밍에서만큼은 명료함이 진화할 수 있는 소프트웨어의 정수다.

> 캠핑자들에게는 "도착했을 때보다 깔끔하게 정돈하고 떠난다"는 규칙이 있다. 프로그래밍도 마찬가지다. 항시 코드베이스를 작업 시작 전보다 건강하게(healthy) 만들어놓고 떠나야 한다.
